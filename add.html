<html>
<head>
<link rel="stylesheet" type="text/css" href="map.css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&libraries=geometry"></script>
<script type="text/javascript" src="jquery.cookie.js"></script>
<script type="text/javascript" src="map.js"></script>
<script type="text/javascript">
    var vertexes = [];

    function saveCoords(marker, timestamp){
        if (typeof timestamp === "undefined"){
            console.log("Time undefined...");
            timestamp = Math.round(new Date().getTime() / 1000);
        }
        $.ajax({
            url: "save.php", 
            data: {lat: marker.getPosition().lat(), long: marker.getPosition().lng(), timestamp: timestamp, password: password}, 
            error: function(data){
                alert("Error uploading: " + data);
            },
            success: function(data){
            }
        });
    }
    
    function getCoords(){
        navigator.geolocation.getCurrentPosition(function(position){
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;
        var coords = new google.maps.LatLng(latitude, longitude);
        var marker = new google.maps.Marker({
                    position: coords,
                    map: window.map
            });

        window.map.panTo(marker.getPosition());
        });
        var timestamp = Math.round(new Date().getTime() / 1000);
        vertexes.push([marker, timestamp]);
    } 

    function submit(){
        if (navigator.geolocation) {
            for(var i = 0; i< vertexes.length; i++){
                saveCoords(vertexes[i][0], vertexes[i][1]);
            }
        }
    }

jQuery(document).ready(function() {
    if (navigator.geolocation) {
        if ($.cookie('auth')){
            window.password = $.cookie('auth');
        } else {
            window.password = window.prompt('Enter password:');
            $.cookie('auth', password, {expires: 30, path: '/'} );  
        }
        getCoords();
        var intervalID = setInterval(getCoords, 300000);
    } else {
        alert("Your browser doesn't support geolocation. This page will do nothing.");
    }
});

	</script>
</head>
<body>
<div id="map"></div>
<button type="button" onclick="submit();">Update maps...</button> 
</body>
</html> 